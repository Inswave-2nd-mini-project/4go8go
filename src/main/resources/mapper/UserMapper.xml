<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.UserMapper">

    <resultMap type="Users" id="userMap">
        <id property="userId" column="user_id" />
        <result property="email" column="email" />
        <result property="name" column="name" />
        <result property="phone" column="phone" />
        <result property="password" column="password" />
        <result property="nickname" column="nickname" />
        <result property="address" column="address" />
        <result property="birthDate" column="birth_date" />
        <result property="points" column="points" />
        <result property="rating" column="rating" />
        <result property="receiveMail" column="receive_mail" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="status" column="status" />
        <collection property="roleList" resultMap="roleMap" />
    </resultMap>

    <resultMap type="UserRole" id="roleMap">
        <result property="userId" column="user_id" />
        <result property="roleName" column="role_name" />
    </resultMap>

    <select id="login" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.password, u.nickname, u.address,
               u.birth_date, u.points, u.rating, u.receive_mail, u.email_verified,
               u.created_at, u.updated_at, u.status, r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>

    <!-- 자동 생성된 키(user_id)를 반환받도록 useGeneratedKeys와 keyProperty 추가 -->
    <insert id="join" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO user(email, name, phone, password, nickname, address, birth_date, receive_mail, email_verified, social_type, social_id)
        VALUES(#{email}, #{name}, #{phone}, #{password}, #{nickname}, #{address}, #{birthDate}, #{receiveMail}, #{emailVerified}, #{socialType}, #{socialId})
    </insert>

    <insert id="insertAuth">
        INSERT INTO user_role(user_id, role_name)
        VALUES(#{userId}, #{roleName})
    </insert>

    <select id="getAllUsers" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
    </select>

    <select id="getUserById" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>
    
    <select id="findById" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE u.user_id = #{userId}
    </select>

    <select id="getUserByEmail" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.created_at, u.updated_at, u.status,
               r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>
    
    <select id="findByEmail" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.created_at, u.updated_at,
               r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>

    <!-- 사용자 정보 수정 -->
    <update id="updateUser" parameterType="Users">
        UPDATE user
        SET
        name = #{name},
        nickname = #{nickname},
        phone = #{phone},
        address = #{address},
        birth_date = #{birthDate},
        receive_mail = #{receiveMail},
        <if test="status != null">
            status = #{status},
        </if>
        <if test="password != null and password != ''">
            password = #{password},
        </if>
        updated_at = NOW()
        WHERE user_id = #{userId}
    </update>

    <delete id="deleteUser">
        DELETE FROM user WHERE email = #{email}
    </delete>

    <!-- 오늘 생일인 사용자 목록 조회 -->
    <select id="findUsersByBirthdayToday" resultMap="userMap">
        SELECT u.user_id, u.email, u.password, u.nickname, u.address,
        u.birth_date, u.points, u.rating, u.receive_mail,
        u.created_at, u.updated_at, r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE MONTH(u.birth_date) = MONTH(CURRENT_DATE)
        AND DAY(u.birth_date) = DAY(CURRENT_DATE)
    </select>

    <!-- 이메일이 존재하는지 여부 -->
    <select id="existsByEmail" resultType="boolean">
        SELECT EXISTS (
        SELECT 1 FROM user WHERE email = #{email}
        )
    </select>

</mapper>