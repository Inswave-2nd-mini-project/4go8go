<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>알림 목록 - 4고8고마켓</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/index.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/footer.css}" />
    <style>
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            position: relative;
            cursor: pointer;
        }
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        .notification-unread {
            background-color: #f0f7ff;
        }
        .notification-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .notification-content {
            margin-bottom: 5px;
        }
        .empty-notification {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .mark-all-read {
            margin-bottom: 15px;
        }
        .notification-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 10px;
            height: 10px;
        }
    </style>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body th:data-authenticated="${#authorization.expression('isAuthenticated()')}">
  
<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 알림 목록 -->
<div class="container my-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">알림 목록</h4>
                    <span th:if="${unreadCount > 0}" class="badge bg-danger" th:text="${unreadCount}"></span>
                </div>
                <div class="card-body">
                    <button id="markAllReadBtn" class="btn btn-outline-primary mb-3" th:if="${unreadCount > 0}">
                        모두 읽음 처리
                    </button>

                    <div th:if="${notifications.empty}" class="empty-notification">
                        <i class="bi bi-bell-slash fs-1"></i>
                        <p class="mt-3">알림이 없습니다.</p>
                    </div>

                    <div th:unless="${notifications.empty}">
                        <div th:each="notification : ${notifications}" 
                             th:class="'notification-item ' + (${!notification.read} ? 'notification-unread' : '')"
                             th:data-id="${notification.notificationId}"
                             th:data-url="${notification.url}">
                            
                            <div th:if="${!notification.read}" class="notification-badge"></div>
                            
                            <div class="notification-content" th:text="${notification.content}"></div>
                            
                            <div class="notification-time" 
                                 th:text="${#dates.format(notification.createdAt, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/notification-sse.js}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    
    const headers = {
        'Content-Type': 'application/json'
    };
    
    if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
    }
    
    // 알림 항목 클릭 이벤트
    const notificationItems = document.querySelectorAll('.notification-item');
    notificationItems.forEach(item => {
        item.addEventListener('click', function() {
            const notificationId = this.getAttribute('data-id');
            const notificationUrl = this.getAttribute('data-url');
            
            // 읽음 처리 API 호출
            fetch(`/api/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: headers
            })
            .then(response => {
                if (response.ok) {
                    // 읽음 처리 성공 시 해당 알림의 스타일 변경
                    this.classList.remove('notification-unread');
                    const badge = this.querySelector('.notification-badge');
                    if (badge) badge.remove();
                    
                    // 알림 개수 업데이트
                    updateUnreadCount();
                    
                    // 링크가 있으면 해당 페이지로 이동
                    if (notificationUrl) {
                        window.location.href = notificationUrl;
                    }
                }
            })
            .catch(error => {
                console.error('알림 읽음 처리 오류:', error);
            });
        });
    });
    
    // 모두 읽음 처리 버튼 이벤트
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            fetch('/api/notifications/read-all', {
                method: 'POST',
                headers: headers
            })
            .then(response => {
                if (response.ok) {
                    // 모든 알림의 스타일 변경
                    document.querySelectorAll('.notification-unread').forEach(item => {
                        item.classList.remove('notification-unread');
                        const badge = item.querySelector('.notification-badge');
                        if (badge) badge.remove();
                    });
                    
                    // 모두 읽음 버튼 숨기기
                    markAllReadBtn.style.display = 'none';
                    
                    // 알림 개수 업데이트
                    updateUnreadCount();
                }
            })
            .catch(error => {
                console.error('모든 알림 읽음 처리 오류:', error);
            });
        });
    }
    
    // 알림 개수 업데이트 함수
    function updateUnreadCount() {
        fetch('/api/notifications/count')
            .then(response => response.json())
            .then(data => {
                const unreadCount = data.count;
                const badge = document.querySelector('.card-header .badge');
                
                // 헤더의 알림 뱃지 업데이트
                const headerBadge = document.getElementById('notificationBadge');
                if (headerBadge) {
                    if (unreadCount > 0) {
                        headerBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        headerBadge.style.display = 'block';
                    } else {
                        headerBadge.style.display = 'none';
                    }
                }
                
                // 페이지 내 알림 개수 뱃지 업데이트
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // 모두 읽음 버튼 상태 업데이트
                if (markAllReadBtn) {
                    markAllReadBtn.style.display = unreadCount > 0 ? 'block' : 'none';
                }
            })
            .catch(error => {
                console.error('알림 개수 조회 오류:', error);
            });
    }
});
</script>
</body>
</html>